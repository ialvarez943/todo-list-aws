pipeline {
    agent any
    
    options {
        skipDefaultCheckout()
    }

	environment {
        ENVIRONMENT = 'production'
        GIT_BRANCH = 'master'
        GIT_URL = 'github.com/ialvarez943/todo-list-aws.git'
        STACK_NAME = 'production-todo-list-aws'
        PIPELINE_FOLDER = 'PIPELINE-FULL-PRODUCTION'
    }

	stages {

		stage('Get Code') {
			steps {
				echo "-------------------- INFO --------------------"
				sh 'whoami'
				sh 'hostname'
				echo env.WORKSPACE
				echo env.NODE_NAME
				echo "-------------------- Get Code --------------------"
				git branch: "${env.GIT_BRANCH}", url: "https://${env.GIT_URL}"
				stash name: 'code', includes: '**'
			}
      	}

		stage("Build") {
            steps {
				echo "-------------------- INFO --------------------"
				sh 'whoami'
				sh 'hostname'
				echo env.WORKSPACE
				echo env.NODE_NAME
                echo "-------------------- Build --------------------"
                sh "bash pipelines/common-steps/build.sh"
            }
        }

        stage("Deploy") {
            steps {
				echo "-------------------- INFO --------------------"
				sh 'whoami'
				sh 'hostname'
				echo env.WORKSPACE
				echo env.NODE_NAME
                echo "-------------------- Deploy --------------------"
                sh "bash pipelines/common-steps/deploy.sh"
				script {
                    def BASE_URL = sh( script: "aws cloudformation describe-stacks --stack-name ${env.STACK_NAME} --query 'Stacks[0].Outputs[?OutputKey==`BaseUrlApi`].OutputValue' --region us-east-1 --output text > api_url.txt")
					sh '''
						echo "API_URL=$(cat api_url.txt)"
					'''
				}
				stash name: 'api_url', includes: 'api_url.txt'
            }
        }

		stage("Rest Test") {
			agent {
				label 'agent2'
			}
            steps {
				echo "-------------------- INFO --------------------"
				sh 'whoami'
				sh 'hostname'
				echo env.WORKSPACE
				echo env.NODE_NAME
				unstash name:'code'
				echo "-------------------- Setup --------------------"
				sh "bash pipelines/${env.PIPELINE_FOLDER}/setup.sh"
                echo "-------------------- Rest Test --------------------"
				unstash name:'api_url'
				sh '''
					API_URL="$(cat api_url.txt)"
					echo "$API_URL"
					bash pipelines/common-steps/integration.sh "$API_URL"
				'''
            }
            post {
                always {
                    junit 'result-integration.xml'
					cleanWs()
                }
            }
        }
	}

	post { 
        always { 
            echo 'Clean env: delete dir'
            cleanWs()
        }
    }
}

